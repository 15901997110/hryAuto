<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="Bookmark" href="/favicon.ico">
    <link rel="Shortcut Icon" href="/favicon.ico"/>
    <!--[if lt IE 9]-->
    <script type="text/javascript" src="lib/html5shiv.js"></script>
    <script type="text/javascript" src="lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="lib/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css"/>
    <link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css"/>

    <title>新增用例</title>
</head>
<body>
<article class="page-container">
    <form method="post" class="form form-horizontal" id="form-admin-role-add">
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;"><span class="c-red">*</span>服务：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <span class="select-box" style="width:100%;">
                    <select class="select" size="1" name="service" id="service" onchange="serviceChange()">
                        <!--<option value="" selected>请选择服务</option>-->
                    </select>
				</span>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;"><span class="c-red">*</span>接口：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <span class="select-box" style="width:100%;" id="ti-span">
                    <select class="select" prevalue="" size="1" name="ti" id="ti"
                            onchange="tiChange(getCasename(),this.getAttribute('prevalue'))">
                    </select>
				</span>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;"><span class="c-red">*</span>用例名称：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <input type="text" class="input-text" value="" placeholder="用例名称" id="caseName" name="caseName"
                       style="width:100%;">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">用例描述：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <input type="text" class="input-text" value="" placeholder="用例描述" id="remark" name="remark"
                       style="width:100%;">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">环境：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <span class="select-box" style="width:100%;">
                    <select class="select" size="1" name="env" id="env">
                        <option value="0" selected>请选择环境</option>
                    </select>
				</span>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">测试类：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <span class="select-box" style="width:100%;">
                    <select class="select" size="1" name="testclass" id="testclass">
                        <option value="" selected>请选择测试类</option>
                    </select>
				</span>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">请求参数：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <textarea id="requestParam" name="requestParam" cols="" rows="" class="textarea valid"
                          placeholder="请输入请求参数..." style="width:100%;"></textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;"><span class="c-red">*</span>断言类型：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <span class="select-box" style="width:100%;">
                    <select class="select" size="1" name="assertType" id="assertType" onchange="assertTypeChage()">
                        <option value="" selected>请选择断言类型</option>
                    </select>
				</span>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">期望结果：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <textarea id="expected" name="expected" cols="" rows="" class="textarea valid"
                          placeholder="" style="width:100%;"></textarea>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3" style="width:20%;">设计人：</label>
            <div class="formControls col-xs-8 col-sm-9" style="width:80%;">
                <input type="text" class="input-text" value="" placeholder="" id="author" name="author"
                       style="width:100%;"
                       disabled="disabled">
            </div>
        </div>
        <div class="row cl">
            <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
                <button type="button" class="btn btn-success radius" id="admin-role-save" name="admin-role-save"
                        onclick="addTcase()"><i class="icon-ok"></i> 确定
                </button>
                <button type="button" class="btn btn-success radius" id="test" name="admin-role-save"
                        onclick="runTcase()"><i class="icon-ok"></i> 测试
                </button>
                <button class="btn" data-dismiss="modal" aria-hidden="true" onclick="layer_close()">关闭</button>
            </div>
        </div>
    </form>
</article>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script> <!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="lib/select2/select2.full.js"></script>
<script type="text/javascript" src="lib/select2/pinyin.js"></script>
<script type="text/javascript" src="lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="lib/jquery.validation/1.14.0/messages_zh.js"></script>
<!--完善用例名称自动赋值功能,by luqiwei-->
<!--<script type="text/javascript">
    (function () {
        var previous=null;
        $("#ti").on('focus', function () {
            // Store the current value on focus and on change
            previous = this.val().text;
        }).change(function () {
            // Do something with the previous value after the change
            alert(previous);

            // Make sure the previous value is updated
            previous = this.val().text;
            alert(previous);
        });
    })();
</script>-->

<script type="text/javascript">
    //loading
    var layerIndex;
    $(function () {
        $.ajaxSetup({
            layerIndex: -1,
            beforeSend: function () { //插件加载前
                layerIndex = layer.load(1, {shade: [1.01, '#fff']});
            },
            error: function () { //报错时执行
                layer.alert('显示异常，请刷新后重试', {
                    skin: 'layui-layer-molv'
                    , closeBtn: 0
                    , shift: 4 //动画类型
                });
            }
        });
    });

    function getServiceList() {
        var service = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/tservice/selectByConditionSimple",
            data: {},
            dataType: "json",
            success: function (data) {
                var status = data.status;
                var msg = data.msg;
                if (status == 0) {
                    layer.close(layerIndex);
                    service = data.data;
                } else {
                    layer.close(layerIndex);
                    alert(msg);
                }

            },
            fail: function (data) {
                layer.close(layerIndex);
                alert(JSON.stringify(data));
            },
            error: function (xhr) {
                layer.close(layerIndex);
                alert('error:' + JSON.stringify(xhr));
            }
        });
        return service;
    }

    function getCasename() {
        return $("#caseName").val();
    }

    function getTenvList() {
        var env = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/tenv/selectAll",
            data: {},
            dataType: "json",
            success: function (data) {
                var status = data.status;
                var msg = data.msg;
                if (status == 0) {
                    layer.close(layerIndex);
                    env = data.data;
                } else {
                    layer.close(layerIndex);
                    alert(msg);
                }

            },
            fail: function (data) {
                layer.close(layerIndex);
                alert(JSON.stringify(data));
            },
            error: function (xhr) {
                layer.close(layerIndex);
                alert('error:' + JSON.stringify(xhr));
            }
        });
        return env;
    }

    function getTiList(serviceid) {
        var tiList = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/ti/selectByConditionSimple",
            data: {
                serviceid: serviceid
            },
            dataType: "json",
            success: function (data) {
                var status = data.status;
                var msg = data.msg;
                if (status == 0) {
                    layer.close(layerIndex);
                    tiList = data.data;
                } else {
                    layer.close(layerIndex);
                    layer.alert(msg, {
                        icon: 0,
                        skin: 'layer-ext-moon'
                    });
                }

            },
            fail: function (data) {
                layer.close(layerIndex);
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                });
            },
            error: function (xhr) {
                layer.close(layerIndex);
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                });
            }
        });
        return tiList;
    }

    function getTestclass(serviceKey) {
        var testclassList = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/tservice/getTestClassesBySKey",
            data: {
                sKey: serviceKey
            },
            dataType: "json",
            success: function (data) {
                var status = data.status;
                var msg = data.msg;
                if (status == 0) {
                    //layer.close(layerIndex);
                    testclassList = data.data;
                } else {
                    //layer.close(layerIndex);
                    layer.alert(msg, {
                        icon: 0,
                        skin: 'layer-ext-moon'
                    });
                }

            },
            fail: function (data) {
                //layer.close(layerIndex);
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                });
            },
            error: function (xhr) {
                layer.close(layerIndex);
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                });
            }
        });
        return testclassList;
    }

    function getAssertType() {
        var assertType = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "get",
            url: "/enum/assertTypeEnum",
            data: {},
            dataType: "json",
            success: function (data) {
                layer.close(layerIndex);
                assertType = data;
            },
            fail: function (data) {
                layer.close(layerIndex);
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                });
            },
            error: function (xhr) {
                layer.close(layerIndex);
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                });
            }
        });
        return assertType;
    }

    function getOneTi(tId) {
        var ti;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/ti/selectOne",
            data: {
                id: tId
            },
            dataType: "json",
            success: function (data) {
                ti = data.data;
                layer.close(layerIndex);
            },
            fail: function (data) {
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                });
            },
            error: function (xhr) {
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                });
            }
        });
        return ti;


    }

    //根据用例id查询用例信息
    function getTcaseById(caseId) {
        var tcase = null;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/tcase/selectOne",
            data: {
                id: caseId
            },
            dataType: "json",
            success: function (data) {

                //layer.close(layerIndex);
                var status = data.status;
                var msg = data.msg;
                if (status == 0) {
                    tcase = data.data;
                } else {
                    layer.alert(msg, {
                        icon: 0,
                        skin: 'layer-ext-moon'
                    })
                }

            },
            fail: function (data) {
                layer.close(layerIndex);
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                })
            },
            error: function (xhr) {
                layer.close(layerIndex);
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                })
            }
        });
        return tcase;
    }

    /*function getTitype(tId) {
        var titype;
        $.ajaxSetup({async: false});
        $.ajax({
            type: "post",
            url: "/ti/selectOne",
            data: {
                id: tId
            },
            dataType: "json",
            success: function (data) {
                titype = data.data.iparamtype;
                layer.close(layerIndex);
            },
            fail: function (data) {
                layer.alert(JSON.stringify(data), {
                    icon: 0,
                    skin: 'layer-ext-moon'
                });
            },
            error: function (xhr) {
                layer.alert('Error' + JSON.stringify(xhr), {
                    icon: 2,
                    skin: 'layer-ext-moon'
                });
            }
        });
        return titype;

    }*/

    $(document).ready(function () {
        //$("#iparamsample").hide();
        var realName = $.cookie('realnameCookie');
        $("#author").val(realName);
        var serviceList = getServiceList();
        var env = getTenvList();
        var assertTypeList = getAssertType();
        var selectedEnv = null;
        var selectedService = null;
        var selectedTi = null;
        var selectedAssertType = null;
        var selectedRequestparam = null;
        var selectedTestclass = null;
        var selectedCaseName = false;

        /*        if (getParameter('cellArr') != null && getParameter('cellArr') != "") {
                    var cells = getParameter('cellArr').split(",");
                    selectedRequestparam = getParameter('requestparam');
                    selectedExpected = getParameter('expected');
                    $("#caseName").val(cells[0]);
                    $("#remark").val(cells[1]);
                    $("#requestParam").val(selectedRequestparam);
                    $("#expected").val(selectedExpected);

                    selectedEnv = cells[3];
                    selectedService = cells[2];
                    selectedTi = cells[5];
                    selectedAssertType = cells[6];
                }*/
        if (getParameter('id') != null && getParameter('id') != "") {
            //debugger;
            var tcase = getTcaseById(getParameter('id'));
            $("#caseName").val(tcase.casename);
            selectedCaseName = true;
            $("#remark").val(tcase.remark);
            /*$("#requestParam").val(tcase.requestparam);*/

            $("#expected").val(tcase.expected);

            selectedEnv = tcase.envid;
            selectedService = tcase.serviceid;
            selectedTi = tcase.iid;
            selectedAssertType = tcase.asserttype;
            selectedRequestparam = tcase.requestparam;
            selectedTestclass = tcase.testclass;
        }
        var tenv = "";
        for (k = 0; k < env.length; k++) {
            var row = env[k];
            var rowHtml;
            if (row.id == selectedEnv) {
                rowHtml = "<option selected = \"selected\" value=\"" + row.id + "\">" + row.envkey + "</option>";
            } else {
                rowHtml = "<option value=\"" + row.id + "\">" + row.envkey + "</option>";
            }
            tenv = tenv + rowHtml;
        }
        $("#env").append(tenv);


        var services = "";

        for (i = 0; i < serviceList.length; i++) {
            var row = serviceList[i];
            var rowHtml;
            if (row.id == selectedService) {
                rowHtml = "<option selected = \"selected\" value=\"" + row.id + "\">" + row.servicekey + "</option>"
            } else {
                rowHtml = "<option value=\"" + row.id + "\">" + row.servicekey + "</option>"
            }
            services = services + rowHtml;
        }
        $("#service").append(services);


        var serviceId = $("#service").val();
        var tiList = getTiList(serviceId);
        var tis = "";
        if (tiList.length == 0) {
            $("#ti").empty();
            tis = "<option value=\"\" style='color:red'>该服务下无接口</option>";
            $("#ti").append(tis);
        } else {
            for (var j = 0; j < tiList.length; j++) {
                var row = tiList[j];
                var rowHtml;
                if (selectedTi == null && j == 0) {
                    rowHtml = "<option value=\"" + row.id + "\" selected>" + row.iuri + "(" + row.remark + ")</option>";
                } else {
                    rowHtml = "<option value=\"" + row.id + "\">" + row.iuri + "(" + row.remark + ")</option>";
                }
                tis = tis + rowHtml;
            }
            $("#ti").append(tis);
            $("#ti").select2();
            if (selectedTi != null) {//如果是复制用例,这里选中
                $("#ti").val(selectedTi);
            }
            var tiSelectedText = $("#ti").find("option:selected").text();
            var prevalue = tiSelectedText.substring(tiSelectedText.indexOf('(') + 1, tiSelectedText.lastIndexOf(')'));
            document.getElementById("ti").setAttribute("prevalue", prevalue);


            /**
             * 设置参数值
             */
            var tId = $("#ti").val();
            var iparamsample = getOneTi(tId).iparamsample;
            var iparamtype = getOneTi(tId).iparamtype;
            if (selectedRequestparam == null) {//如果不是复制用例,则使用接口的示例参数填充
                if (iparamsample.length > 0 && iparamtype == 1) {
                    var requestJson = JSON.stringify(JSON.parse(iparamsample), null, 2);
                    $("#requestParam").val(requestJson);
                } else {
                    $("#requestParam").val(iparamsample);
                }
            } else if (iparamtype == 1 && $.trim(selectedRequestparam) != "") {//如果是复制用例,并且接口的参数类型是Json,则设置格式化的复制的参数
                $("#requestParam").val(JSON.stringify(JSON.parse(selectedRequestparam), null, 2));
            } else {//否则 ,使用复制的参数直接填充
                $("#requestParam").val(selectedRequestparam);
            }

            if (!selectedCaseName) {
                $("#caseName").val(prevalue);//如果不用复制用例,则这里设置为prevalue的值(即默认接口名称)
            }
        }

        /**
         * 构造testclass
         */
        var selectedServiceKey = $("#service").find("option:selected").text();
        var testclassList = getTestclass(selectedServiceKey);
        var testclassHtml = "";
        for (var i = 0; i < testclassList.length; i++) {
            testclassHtml = testclassHtml + "<option value=\"" + testclassList[i] + "\">" + testclassList[i] + "</option>";
        }
        $("#testclass").append(testclassHtml);
        if (selectedTestclass != null) {
            $("#testclass").val(selectedTestclass);
        }


        var assertTypes = "";
        for (var m = 0; m < assertTypeList.length; m++) {
            var row = assertTypeList[m];
            var rowHtml;
            if (row.id == selectedAssertType) {
                rowHtml = "<option selected = \"selected\" value=\"" + row.id + "\">" + row.value + "</option>";
            } else {
                rowHtml = "<option value=\"" + row.id + "\">" + row.value + "</option>";
            }
            assertTypes = assertTypes + rowHtml;
        }
        $("#assertType").append(assertTypes);
        layer.close(layerIndex);

    });

    function getParameter(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return decodeURI(r[2]);
        return null;
    }

    //接口改变处理
    function tiChange(cName, prevalue) {
        /*        console.log(cName);
                console.log(prevalue);*/
        var tId = $("#ti").val();
        var t = getOneTi(tId);
        var remark = t.remark;
        if ($.trim(cName) == $.trim(prevalue) || $.trim(cName) == "") {//如果prevalue==cName,证明用户并没有编辑caseName,此时接口变更时,将会填充新的值
            $("#caseName").val(remark);
        }
        document.getElementById("ti").setAttribute("prevalue", remark);//设置新的自定义属性-prevalue,为下次change准备
        var iparamsample = t.iparamsample;
        //var iparamtype = getTitype(tId);
        var iparamtype = t.iparamtype;
        if (iparamsample.length > 0 && iparamtype == 1) {
            try {
                var requestJson = JSON.stringify(JSON.parse(iparamsample), null, 2);
                $("#requestParam").val(requestJson);
            } catch (e) {
                $("#requestParam").val(iparamsample);
            }
        } else {
            $("#requestParam").val(iparamsample);
        }
        //$("#requestParam").empty();
    }


    //服务改变处理
    function serviceChange() {
        var serviceId = $("#service").val();
        var tiList = getTiList(serviceId);
        var tis = "";
        if (tiList.length == 0) {
            $("#ti").empty();
            tis = "<option value=\"\" style='color:red'>该服务下无接口</option>";
            $("#ti").append(tis);
            $("#caseName").val("");
            $("#requestParam").val("");
        } else {
            for (var j = 0; j < tiList.length; j++) {
                var row = tiList[j];
                var rowHtml = "<option value=\"" + row.id + "\">" + row.iuri + "(" + row.remark + ")</option>";
                tis = tis + rowHtml;
            }
            //$("#ti").find("option:selected").text("");
            $("#ti").empty();
            $("#ti").append(tis);
            $("#ti").select2();
            tiChange();

        }
        //服务改变时,测试类也需要联动
        var selectedServiceKey = $("#service").find("option:selected").text();
        var testclassList = getTestclass(selectedServiceKey);
        var testclassHtml = "<option value=\"\" selected>请选择测试类</option>";
        for (var i = 0; i < testclassList.length; i++) {
            testclassHtml = testclassHtml + "<option value=\"" + testclassList[i] + "\">" + testclassList[i] + "</option>";
        }
        $("#testclass").empty();
        $("#testclass").append(testclassHtml);

        layer.close(layerIndex);

    }

    //断言类型改变处理
    function assertTypeChage() {
        var assertType = $("#assertType").val();
        var assertTypeList = getAssertType();
        var placeholder = "";
        for (var i = 0; i < assertTypeList.length; i++) {
            var row = assertTypeList[i];
            if (row.id == assertType) {
                placeholder = row.desc;
                $("#expected").prop("placeholder", placeholder);
                break;
            } else {
                $("#expected").prop("placeholder", "");
            }
        }


    }

    //添加用例
    function addTcase() {
        var caseName = $("#caseName").val();
        var remark = $("#remark").val();
        var env = $("#env").val();
        var service = $("#service").val();
        var ti = $("#ti").val();
        var requestParam = $("#requestParam").val();
        var assertType = $("#assertType").val();
        var expected = $("#expected").val();
        var author = $("#author").val();
        var testclass = $("#testclass").val()

        if (caseName == null || caseName == "") {
            layer.alert("用例名称不能为空！");
            return;
        } else if (ti == null || ti == "") {
            layer.alert("请选择接口！");
            return;
        } else if (assertType == null || assertType == "") {
            layer.alert("请选择断言类型！");
            return;
        } else {
            $.ajax({
                type: "post",
                url: "/tcase/insertOne",
                data: {
                    casename: caseName,
                    remark: remark,
                    serviceid: service,
                    iid: ti,
                    envid: env,
                    requestparam: requestParam,
                    asserttype: assertType,
                    expected: expected,
                    author: author,
                    testclass: testclass
                },
                dataType: "json",
                success: function (data) {
                    var status = data.status;
                    var msg = data.msg;
                    if (status == 0) {
                        parent.window.location.reload();
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    } else {
                        layer.close(layerIndex);
                        layer.alert(msg, {
                            icon: 0,
                            skin: 'layer-ext-moon'
                        });
                    }

                },
                fail: function (data) {
                    layer.close(layerIndex);
                    layer.alert(JSON.stringify(data), {
                        icon: 0,
                        skin: 'layer-ext-moon'
                    });
                },
                error: function (xhr) {
                    layer.close(layerIndex);
                    layer.alert('Error' + JSON.stringify(xhr), {
                        icon: 2,
                        skin: 'layer-ext-moon'
                    });
                }
            });
        }

    }

    //运行用例
    function runTcase() {
        var caseName = $("#caseName").val();
        var remark = $("#remark").val();
        var env = $("#env").val();
        var service = $("#service").val();
        var ti = $("#ti").val();
        var requestParam = $("#requestParam").val();
        var assertType = $("#assertType").val();
        var expected = $("#expected").val();
        var author = $("#author").val();

        if (ti == null || ti == "") {
            layer.alert("请选择接口！");
            return;
        } else if (assertType == null || assertType == "") {
            layer.alert("请选择断言类型！");
            return;
        } else {
            $.ajax({
                type: "post",
                url: "/tcase/runCaseOne",
                data: {
                    casename: caseName,
                    remark: remark,
                    iid: ti,
                    envid: env,
                    serviceid: service,
                    requestparam: requestParam,
                    asserttype: assertType,
                    expected: expected
                    /*author:author,
                    status:1*/
                },
                dataType: "json",
                success: function (data) {
                    var list = data;
                    var status = data.status;
                    var msg = data.msg;
                    if (status == 0) {
                        layer.close(layerIndex);
                        var domain = "http://" + window.location.host;
                        var myPopup = window.open("test-result.html");//.postMessage(list,domain);
                        //周期性的发送消息
                        setTimeout(function () {
                            myPopup.postMessage(list, domain);
                        }, 1000);
                        /* parent.window.location.reload();
                         var index = parent.layer.getFrameIndex(window.name);
                         parent.layer.close(index);*/
                    } else {
                        layer.close(layerIndex);
                        layer.alert(msg, {
                            icon: 0,
                            skin: 'layer-ext-moon'
                        });
                    }

                },
                fail: function (data) {
                    layer.close(layerIndex);
                    layer.alert(JSON.stringify(data), {
                        icon: 0,
                        skin: 'layer-ext-moon'
                    });
                },
                error: function (xhr) {
                    layer.close(layerIndex);
                    layer.alert('Error' + JSON.stringify(xhr), {
                        icon: 2,
                        skin: 'layer-ext-moon'
                    });
                }
            });
        }


    }


</script>

</body>
</html>